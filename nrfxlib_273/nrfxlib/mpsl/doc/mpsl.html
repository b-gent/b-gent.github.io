

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Integration notes &mdash; nrfxlib 1.3.99 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/js/ncs.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/nrfxlib.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Timeslot" href="timeslot.html" />
    <link rel="prev" title="Changelog" href="../CHANGELOG.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../README.html" class="icon icon-home"> nrfxlib
          

          
          </a>

          
            
            
              <div class="version">
                1.3.99
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Libraries:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../bsdlib/README.html">BSD library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/README.html">Crypto Libraries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../README.html">Multiprotocol Service Layer</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../CHANGELOG.html">Changelog</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Integration notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#thread-and-interrupt-safety">Thread and Interrupt Safety</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#interrupt-configuration">Interrupt configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scheduling">Scheduling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="timeslot.html">Timeslot</a></li>
<li class="toctree-l2"><a class="reference internal" href="radio_notification.html">Radio notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="tx_power_control.html">TX Power Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html">API documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf_security/README.html">Nordic Security Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nfc/README.html">Near Field Communication (NFC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openthread/README.html">OpenThread pre-built libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../softdevice_controller/README.html">SoftDevice Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zboss/README.html">ZBOSS Zigbee stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf_rpc/README.html">Remote procedure call library (nRF RPC)</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../README.html">nrfxlib</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../README.html">Docs</a> &raquo;</li>
        
          <li><a href="../README.html">Multiprotocol Service Layer</a> &raquo;</li>
        
      <li>Integration notes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/mpsl/doc/mpsl.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="integration-notes">
<span id="mpsl-lib"></span><h1>Integration notes<a class="headerlink" href="#integration-notes" title="Permalink to this headline">¶</a></h1>
<p>This page describes how to integrate the Multiprotocol Service Layer (MPSL) into an application.
The descriptions are valid for both RTOS and RTOS-free environments.</p>
<p>For the nRF53 Series, the requirements described are only relevant for applications running alongside the MPSL on the network processor.</p>
<p>The following peripherals are owned by MPSL and must not be accessed directly by the application:</p>
<blockquote>
<div><ul class="simple">
<li><p>RTC0</p></li>
<li><p>TIMER0</p></li>
<li><p>RADIO</p></li>
<li><p>CLOCK</p></li>
<li><p>TEMP</p></li>
<li><p>PPI channel 19, 30, 31, for the nRF52 Series</p></li>
<li><p>DPPI channels 0 - 2, for the nRF53 Series</p></li>
</ul>
</div></blockquote>
<p>Limited access to these peripherals is provided through the MPSL Timeslot module and through other MPSL APIs.</p>
<div class="section" id="thread-and-interrupt-safety">
<h2>Thread and Interrupt Safety<a class="headerlink" href="#thread-and-interrupt-safety" title="Permalink to this headline">¶</a></h2>
<p>The MPSL library is not reentrant, so for thread-safe operation, some considerations must be made.</p>
<div class="section" id="interrupt-configuration">
<h3>Interrupt configuration<a class="headerlink" href="#interrupt-configuration" title="Permalink to this headline">¶</a></h3>
<p>MPSL enables interrupts for RTC0, TIMER0, POWER_CLOCK, and <code class="docutils literal notranslate"><span class="pre">low_prio_irq</span></code>.
All other interrupts must be enabled and configured by the application.
If the Timeslot API is used for RADIO access, the application is responsible for enabling and disabling the interrupt for RADIO.</p>
<p>Interrupts for RTC0, TIMER0, and RADIO must be configured for priority level 0 (<a class="reference internal" href="api.html#c.MPSL_HIGH_IRQ_PRIORITY" title="MPSL_HIGH_IRQ_PRIORITY"><code class="xref c c-macro docutils literal notranslate"><span class="pre">MPSL_HIGH_IRQ_PRIORITY</span></code></a>) by the application.</p>
<p>The following interrupts do not have real time requirements:</p>
<blockquote>
<div><ul>
<li><p>POWER_CLOCK interrupt</p>
<p>It is up to the application to forward any clock related events to <a class="reference internal" href="api.html#_CPPv422MPSL_IRQ_CLOCK_Handlerv" title="MPSL_IRQ_CLOCK_Handler"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MPSL_IRQ_CLOCK_Handler()</span></code></a> in lower priority.
Irrelevant events are ignored, so the application is free to forward all events for the POWER_CLOCK interrupt.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">low_prio_irq</span></code> interrupt</p>
<p>Low priority work is signaled by MPSL by pending the IRQ specified in the <code class="docutils literal notranslate"><span class="pre">low_prio_irq</span></code> argument to <a class="reference internal" href="api.html#_CPPv49mpsl_initPK22mpsl_clock_lfclk_cfg_t9IRQn_Type21mpsl_assert_handler_t" title="mpsl_init"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_init()</span></code></a>.
When this interrupt is triggered, <a class="reference internal" href="api.html#_CPPv425mpsl_low_priority_processv" title="mpsl_low_priority_process"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_low_priority_process()</span></code></a> should be called as soon as possible, at least within a couple of ms.
The application should configure this interrupt priority lower than c:macro:MPSL_HIGH_IRQ_PRIORITY level (that is, a higher numerical value).
The interrupt is enabled with <a class="reference internal" href="api.html#_CPPv49mpsl_initPK22mpsl_clock_lfclk_cfg_t9IRQn_Type21mpsl_assert_handler_t" title="mpsl_init"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_init()</span></code></a> and disabled with <a class="reference internal" href="api.html#_CPPv411mpsl_uninitv" title="mpsl_uninit"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_uninit()</span></code></a> by MPSL.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="scheduling">
<h3>Scheduling<a class="headerlink" href="#scheduling" title="Permalink to this headline">¶</a></h3>
<p>Interaction of the MPSL library with protocol stacks is designed to run at two interrupt priority levels: one for the high priority handlers, and one for the low priority handler.
Interaction of the MPSL library with the application happens in thread context and in the low priority handler.</p>
<div class="section" id="high-priority">
<h4>High priority<a class="headerlink" href="#high-priority" title="Permalink to this headline">¶</a></h4>
<p>The high priority handlers are mostly used for timing-critical operations related to radio or scheduling.
Interrupting or delaying these handlers leads to undefined behavior.</p>
</div>
<div class="section" id="low-priority">
<h4>Low priority<a class="headerlink" href="#low-priority" title="Permalink to this headline">¶</a></h4>
<p>Low priority is used for background tasks that are not directly tied to the radio or scheduling.
These tasks are designed in such a way that they can be interrupted by high priority code.
The tasks are however not designed to be interrupted by other low priority tasks.
Therefore, make sure that only one MPSL API function is called from the application at any time.</p>
<blockquote>
<div><ul class="simple">
<li><p>All protocol stacks using MPSL must be synchronized (i.e. not called concurrently) to avoid concurrent calls to MPSL functions.</p></li>
<li><p>Application must only call MPSL APIs from non-preemptible threads, or with interrupts disabled (e.g. during initialization).</p></li>
<li><p>The <a class="reference internal" href="api.html#_CPPv425mpsl_low_priority_processv" title="mpsl_low_priority_process"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_low_priority_process()</span></code></a> function should only be called from thread context, i.e. not directly from the software interrupt handler.</p></li>
<li><p>Alternatively, you can use synchronization primitives to ensure that no MPSL functions are called at the same time.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="other-priorities">
<h4>Other priorities<a class="headerlink" href="#other-priorities" title="Permalink to this headline">¶</a></h4>
<p>MPSL inititialization functions, like <a class="reference internal" href="api.html#_CPPv49mpsl_initPK22mpsl_clock_lfclk_cfg_t9IRQn_Type21mpsl_assert_handler_t" title="mpsl_init"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_init()</span></code></a> and <a class="reference internal" href="api.html#_CPPv411mpsl_uninitv" title="mpsl_uninit"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mpsl_uninit()</span></code></a>, are not thread-safe.
Do not call them while, for example, a protocol timeslot is in progress.
This must be enforced by application and protocol stacks.</p>
<p>MPSL should be initialized before any protocol stack is enabled, and uninitialized after all protocol stacks have been disabled.</p>
</div>
<div class="section" id="architecture-diagrams">
<h4>Architecture diagrams<a class="headerlink" href="#architecture-diagrams" title="Permalink to this headline">¶</a></h4>
<p>The following image shows how the MPSL integrates in an RTOS-free environment.</p>
<div class="figure align-default" id="id1">
<img alt="MPSL integration in an RTOS-free environment" src="../../_images/Architecture_Without_RTOS1.svg" /><p class="caption"><span class="caption-text">MPSL integration in an RTOS-free environment</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>The following image shows how the the MPSL integrates with an RTOS.</p>
<div class="figure align-default" id="id2">
<img alt="MPSL integration with an RTOS" src="../../_images/Architecture_With_RTOS1.svg" /><p class="caption"><span class="caption-text">MPSL integration with an RTOS</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="timeslot.html" class="btn btn-neutral float-right" title="Timeslot" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../CHANGELOG.html" class="btn btn-neutral" title="Changelog" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2019-2020, Nordic Semiconductor.
      Last updated on Sep 30, 2020.

    </p>
</td>
<td id="nordiclogo">
  <a href="https://www.nordicsemi.com/"><img src="../../_static/images/nordic.svg" border="0"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> nrfxlib</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <div class="rst-other-version ncs">
        <a href="../../../nrf/index.html">nRF Connect SDK</a>
      </div>
      <div class="rst-other-version zephyr">
        <a href="../../../zephyr/index.html">Zephyr</a><br/>
      </div>
      <div class="rst-other-version mcuboot">
        <a href="../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      <div class="rst-other-version kconfig">
        <a href="../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>