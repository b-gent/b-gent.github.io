

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Implementing remote procedure calls &mdash; nrfxlib 1.3.99 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/js/ncs.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/nrfxlib.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Architecture" href="architecture.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../README.html" class="icon icon-home"> nrfxlib
          

          
          </a>

          
            
            
              <div class="version">
                1.3.99
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Libraries:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../bsdlib/README.html">BSD library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/README.html">Crypto Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mpsl/README.html">Multiprotocol Service Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf_security/README.html">Nordic Security Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nfc/README.html">Near Field Communication (NFC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openthread/README.html">OpenThread pre-built libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../softdevice_controller/README.html">SoftDevice Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zboss/README.html">ZBOSS Zigbee stack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../README.html">Remote procedure call library (nRF RPC)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Implementing remote procedure calls</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rpc-encoders">RPC Encoders</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rpc-decoders">RPC Decoders</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../README.html#api-documentation">API documentation</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../README.html">nrfxlib</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../README.html">Docs</a> &raquo;</li>
        
          <li><a href="../README.html">Remote procedure call library (nRF RPC)</a> &raquo;</li>
        
      <li>Implementing remote procedure calls</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/nrf_rpc/doc/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="implementing-remote-procedure-calls">
<span id="nrf-rpc-usage"></span><h1>Implementing remote procedure calls<a class="headerlink" href="#implementing-remote-procedure-calls" title="Permalink to this headline">¶</a></h1>
<p>A specific API can be used remotely if RPC encoders and RPC decoders are provided for it.
On one side, there are encoders that encode parameters and send commands or events.
On the other side, there are decoders that decode and execute a specific procedure.</p>
<p>The main goal of nRF RPC API is to allow the creation of RPC encoders and RPC decoders.</p>
<p>Encoders and decoders are grouped.
Each group contains functions related to a single API, such as Bluetooth or entropy.
A group is created with the <a class="reference internal" href="../README.html#c.NRF_RPC_GROUP_DEFINE" title="NRF_RPC_GROUP_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">NRF_RPC_GROUP_DEFINE</span></code></a> macro.
Grouping allows you to logically divide the remote API, but also increases performance of nRF RPC.</p>
<div class="section" id="rpc-encoders">
<h2>RPC Encoders<a class="headerlink" href="#rpc-encoders" title="Permalink to this headline">¶</a></h2>
<p>RPC encoders encode commands and events into serialized packets.
Creating an encoder is similar for all packet types.
The first step is the allocation of a buffer using <a class="reference internal" href="../README.html#c.NRF_RPC_ALLOC" title="NRF_RPC_ALLOC"><code class="xref c c-macro docutils literal notranslate"><span class="pre">NRF_RPC_ALLOC</span></code></a>.
After that, you can encode parameters directly into the buffer or use the <a class="reference external" href="https://github.com/zephyrproject-rtos/tinycbor">TinyCBOR</a> library.
In the last step, the packet is sent using one of the sending functions: <a class="reference internal" href="../README.html#_CPPv411nrf_rpc_cmdPK13nrf_rpc_group7uint8_tP7uint8_t6size_t17nrf_rpc_handler_tPv" title="nrf_rpc_cmd"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cmd()</span></code></a>, <a class="reference internal" href="../README.html#_CPPv416nrf_rpc_cbor_evtPK13nrf_rpc_group7uint8_tP16nrf_rpc_cbor_ctx" title="nrf_rpc_cbor_evt"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cbor_evt()</span></code></a>, or similar.</p>
<p>After sending the command, a response is received, so it must be parsed.
There are two ways to parse a response.</p>
<p>The first way is to provide a response handler in the parameters of <a class="reference internal" href="../README.html#_CPPv411nrf_rpc_cmdPK13nrf_rpc_group7uint8_tP7uint8_t6size_t17nrf_rpc_handler_tPv" title="nrf_rpc_cmd"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cmd()</span></code></a> or <a class="reference internal" href="../README.html#_CPPv416nrf_rpc_cbor_cmdPK13nrf_rpc_group7uint8_tP16nrf_rpc_cbor_ctx22nrf_rpc_cbor_handler_tPv" title="nrf_rpc_cbor_cmd"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cbor_cmd()</span></code></a>.
It is called before <a class="reference internal" href="../README.html#_CPPv411nrf_rpc_cmdPK13nrf_rpc_group7uint8_tP7uint8_t6size_t17nrf_rpc_handler_tPv" title="nrf_rpc_cmd"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cmd()</span></code></a> returns.
It can be called from a different thread.</p>
<p>Another way of parsing a response is to call <a class="reference internal" href="../README.html#_CPPv415nrf_rpc_cmd_rspPK13nrf_rpc_group7uint8_tP7uint8_t6size_tPPK7uint8_tP6size_t" title="nrf_rpc_cmd_rsp"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cmd_rsp()</span></code></a> or <a class="reference internal" href="../README.html#_CPPv420nrf_rpc_cbor_cmd_rspPK13nrf_rpc_group7uint8_tP20nrf_rpc_cbor_rsp_ctx" title="nrf_rpc_cbor_cmd_rsp"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cbor_cmd_rsp()</span></code></a>.
The output of these functions contains the response.
After parsing it, the <a class="reference internal" href="../README.html#_CPPv421nrf_rpc_decoding_donePK7uint8_t" title="nrf_rpc_decoding_done"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_decoding_done()</span></code></a> or <a class="reference internal" href="../README.html#_CPPv426nrf_rpc_cbor_decoding_doneP9CborValue" title="nrf_rpc_cbor_decoding_done"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_cbor_decoding_done()</span></code></a> functions must be called to indicate that parsing is completed and the buffers holding the response can be released.</p>
<p>Events have no response, so they need no additional action after sending them.</p>
<p>The following is a sample command encoder created using the nRF RPC TinyCBOR API.
The function remotely adds <code class="docutils literal notranslate"><span class="pre">1</span></code> to the <code class="docutils literal notranslate"><span class="pre">input</span></code> parameter and puts the result in the <code class="docutils literal notranslate"><span class="pre">output</span></code> parameter.
It returns 0 on success or a negative error code if communication with the remote side failed.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Helper define holding maximum CBOR encoded packet length</span>
<span class="cm"> * for this sample.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_ENCODED_LEN 16</span>

<span class="cm">/* Defines a group that contains functions implemented in this</span>
<span class="cm"> * sample.</span>
<span class="cm"> */</span>
<span class="n">NRF_RPC_GROUP_DEFINE</span><span class="p">(</span><span class="n">math_group</span><span class="p">,</span> <span class="s">&quot;sample_math&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* Defines a helper structure to pass the results.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">remote_inc_result</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">output</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">remote_inc</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">remote_inc_result</span> <span class="n">result</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">nrf_rpc_cbor_ctx</span> <span class="n">ctx</span><span class="p">;</span>

        <span class="n">NRF_RPC_CBOR_ALLOC</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">MAX_ENCODED_LEN</span><span class="p">);</span>

        <span class="n">cbor_encode_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">nrf_rpc_cbor_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">math_group</span><span class="p">,</span> <span class="n">MATH_COMMAND_INC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span>
                               <span class="n">remote_inc_rsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">output</span><span class="p">;</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above code uses the <code class="docutils literal notranslate"><span class="pre">remote_inc_rsp</span></code> function to parse the response.
The following code shows how this function might look.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">remote_inc_rsp</span><span class="p">(</span><span class="n">CborValue</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">handler_data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">CborError</span> <span class="n">cbor_err</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">remote_inc_result</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span>
                <span class="p">(</span><span class="k">struct</span> <span class="n">remote_inc_result</span> <span class="o">*</span><span class="p">)</span><span class="n">handler_data</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cbor_value_is_integer</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">result</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">NRF_EINVAL</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">cbor_err</span> <span class="o">=</span> <span class="n">cbor_value_get_int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cbor_err</span> <span class="o">!=</span> <span class="n">CborNoError</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">result</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">NRF_EINVAL</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">result</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="rpc-decoders">
<h2>RPC Decoders<a class="headerlink" href="#rpc-decoders" title="Permalink to this headline">¶</a></h2>
<p>RPC decoders are registered with macros <a class="reference internal" href="../README.html#c.NRF_RPC_CMD_DECODER" title="NRF_RPC_CMD_DECODER"><code class="xref c c-macro docutils literal notranslate"><span class="pre">NRF_RPC_CMD_DECODER</span></code></a>, <a class="reference internal" href="../README.html#c.NRF_RPC_CBOR_EVT_DECODER" title="NRF_RPC_CBOR_EVT_DECODER"><code class="xref c c-macro docutils literal notranslate"><span class="pre">NRF_RPC_CBOR_EVT_DECODER</span></code></a>, or similar, depending on what kind of decoder it is.
Decoders are called automatically when a command or event with a matching ID is received.
Command decoders must send a response.</p>
<p>A RPC decoder associated with the example above can be implemented in the following way:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Defines a group that contains functions implemented in this</span>
<span class="cm"> * sample. Second parameter have to be the same in both remote</span>
<span class="cm"> * and local side.</span>
<span class="cm"> */</span>
<span class="n">NRF_RPC_GROUP_DEFINE</span><span class="p">(</span><span class="n">math_group</span><span class="p">,</span> <span class="s">&quot;sample_math&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">remote_inc_handler</span><span class="p">(</span><span class="n">CborValue</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">handler_data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">output</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">nrf_rpc_cbor_ctx</span> <span class="n">ctx</span><span class="p">;</span>

        <span class="cm">/* Parsing the input */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cbor_value_is_integer</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">cbor_value_get_int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">nrf_rpc_cbor_decoding_done</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

        <span class="cm">/* Actual hard work is done in below line */</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">input</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* Encoding and sending the response */</span>

        <span class="n">NRF_RPC_CBOR_ALLOC</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">MAX_ENCODED_LEN</span><span class="p">);</span>

        <span class="n">cbor_encode_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">nrf_rpc_cbor_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fatal_error</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="n">NRF_RPC_CBOR_CMD_DECODER</span><span class="p">(</span><span class="n">math_group</span><span class="p">,</span> <span class="n">remote_inc_handler</span><span class="p">,</span>
                         <span class="n">MATH_COMMAND_INC</span><span class="p">,</span> <span class="n">remote_inc_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="architecture.html" class="btn btn-neutral" title="Architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2019-2020, Nordic Semiconductor.
      Last updated on Sep 30, 2020.

    </p>
</td>
<td id="nordiclogo">
  <a href="https://www.nordicsemi.com/"><img src="../../_static/images/nordic.svg" border="0"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> nrfxlib</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <div class="rst-other-version ncs">
        <a href="../../../nrf/index.html">nRF Connect SDK</a>
      </div>
      <div class="rst-other-version zephyr">
        <a href="../../../zephyr/index.html">Zephyr</a><br/>
      </div>
      <div class="rst-other-version mcuboot">
        <a href="../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      <div class="rst-other-version kconfig">
        <a href="../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>