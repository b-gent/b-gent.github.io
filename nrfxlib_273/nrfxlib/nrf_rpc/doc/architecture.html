

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Architecture &mdash; nrfxlib 1.3.99 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/js/ncs.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/common.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/nrfxlib.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Implementing remote procedure calls" href="usage.html" />
    <link rel="prev" title="Remote procedure call library (nRF RPC)" href="../README.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../README.html" class="icon icon-home"> nrfxlib
          

          
          </a>

          
            
            
              <div class="version">
                1.3.99
              </div>
            
          

          
<div id="searchbox" role="search">
  <div class="searchformwrapper">
    <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Libraries:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../bsdlib/README.html">BSD library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/README.html">Crypto Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mpsl/README.html">Multiprotocol Service Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nrf_security/README.html">Nordic Security Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nfc/README.html">Near Field Communication (NFC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openthread/README.html">OpenThread pre-built libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../softdevice_controller/README.html">SoftDevice Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zboss/README.html">ZBOSS Zigbee stack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../README.html">Remote procedure call library (nRF RPC)</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#types-of-communication">Types of communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="#threads">Threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-handling">Error handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lower-layers">Lower layers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transport">Transport</a></li>
<li class="toctree-l4"><a class="reference internal" href="#operating-system-abstraction">Operating system abstraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="usage.html">Implementing remote procedure calls</a></li>
<li class="toctree-l2"><a class="reference internal" href="../README.html#api-documentation">API documentation</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../README.html">nrfxlib</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../README.html">Docs</a> &raquo;</li>
        
          <li><a href="../README.html">Remote procedure call library (nRF RPC)</a> &raquo;</li>
        
      <li>Architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/nrf_rpc/doc/architecture.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="architecture">
<span id="nrf-rpc-architecture"></span><h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h1>
<p>The following picture gives an overview of the nRF RPC architecture:</p>
<div class="figure align-center" id="id1">
<img alt="nRF RPC architecture layers" src="../../_images/layers.svg" /><p class="caption"><span class="caption-text">nRF RPC architecture layers</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="types-of-communication">
<h2>Types of communication<a class="headerlink" href="#types-of-communication" title="Permalink to this headline">¶</a></h2>
<p>You can issue the calls in one of two ways: using a command/response or an event.</p>
<p>A <strong>command and response</strong> is intended to be used for synchronous function calls.
The caller sends the command to the other side and waits for a response.
The response is sent after the remote function returns on the remote core.
The following image shows an example of the command and response flow.</p>
<div class="figure align-center" id="id2">
<img alt="nRF RPC command and response flow" src="../../_images/cmd_flow.svg" /><p class="caption"><span class="caption-text">nRF RPC command and response flow</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p><strong>Events</strong> are intended to be used for asynchronous function calls.
The caller sends an event to the other side and returns immediately if there is a free thread in the thread pool.
See the <a class="reference internal" href="#nrf-rpc-architecture-threads"><span class="std std-ref">Threads</span></a> section.
Otherwise, it waits for an available thread.
It is not possible to return anything from the remote side after receiving an event, but it is possible to send an event in the opposite direction.
The following image shows an example of the event flow.</p>
<div class="figure align-center" id="id3">
<img alt="nRF RPC event flow" src="../../_images/evt_flow.svg" /><p class="caption"><span class="caption-text">nRF RPC event flow</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="threads">
<span id="nrf-rpc-architecture-threads"></span><h2>Threads<a class="headerlink" href="#threads" title="Permalink to this headline">¶</a></h2>
<p>When a remote procedure call is received, it must be executed in the context of a thread.
For this reason, each side of nRF RPC contains a thread pool.
The thread pool is OS-dependent and implemented in the OS abstraction layer.
The number of threads in a thread pool is configurable.</p>
<p>When a caller wants to call a remote procedure, nRF RPC checks if there is a thread available in a pool.
If there is none, then it waits until one becomes available, blocking the caller.
After that, nRF RPC sends a packet and it is executed by an available thread from a thread pool.
In the case of a command being received, a response is sent directly to a waiting thread, so no new thread is allocated for a response.</p>
<p>The following image presents sample command and response flows.</p>
<div class="figure align-center" id="id4">
<img alt="nRF RPC simple command flow" src="../../_images/cmd_simple.svg" /><p class="caption"><span class="caption-text">nRF RPC simple command flow</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>A thread waiting for a response can be reused to receive a new incoming command from the remote thread that the local thread is waiting for, e.g. when a callback is called synchronously.
The following diagram demonstrates this situation.</p>
<div class="figure align-center" id="id5">
<img alt="nRF RPC recursive command flow" src="../../_images/cmd_recursive.svg" /><p class="caption"><span class="caption-text">nRF RPC recursive command flow</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>Events always reserve a new thread from the remote thread pool.
Pay special attention when sending multiple events one after another, because each event reserves a new thread.
Sending events too fast might consume the entire thread pool and, as a result, block all outgoing commands and events until a thread becomes available in the thread pool .
Sample events are shown in the diagram below.</p>
<div class="figure align-center" id="id6">
<img alt="nRF RPC simple event flow" src="../../_images/evt_simple.svg" /><p class="caption"><span class="caption-text">nRF RPC simple event flow</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="error-handling">
<h2>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>Two kinds of errors might occur when using this library.</p>
<blockquote>
<div><dl class="simple">
<dt>Error during parsing of an incoming packet</dt><dd><p>These errors cannot be directly returned to the user as a return value.
The user is informed about such errors through a callback.
First, if the group in which the error happened is known, then a group error callback is called.
Second, a global error handler (provided to the <a class="reference internal" href="../README.html#_CPPv412nrf_rpc_init21nrf_rpc_err_handler_t" title="nrf_rpc_init"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">nrf_rpc_init()</span></code></a> function) is called.
Malformed packets should not normally happen, because the transport layer is responsible for reliable packet transferring.
Such errors are a serious problem from which nRF RPC will probably not recover.</p>
</dd>
<dt>Error during packet sending</dt><dd><p>This kind of errors is passed to the caller as a return value.
They indicate that the transport layer is not able to transfer a packet.
Such errors are a serious problem from which nRF RPC will probably not recover, because missing packets might put nRF RPC in an undefined state.</p>
</dd>
</dl>
</div></blockquote>
<p>You can also pass errors during packet sending to an error handler by using a <code class="docutils literal notranslate"><span class="pre">_no_err</span></code> variant of sending functions.</p>
</div>
<div class="section" id="lower-layers">
<h2>Lower layers<a class="headerlink" href="#lower-layers" title="Permalink to this headline">¶</a></h2>
<p>The lower layers of nRF RPC are OS-dependent.
They are responsible for communicating with a transport medium, managing a thread pool, thread synchronization, communication, and logging.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Detailed knowledge about how the lower layers are implemented is not required when using the nRF RPC API.
However, this knowledge is required to implement an alternative transport or to port to a different operating system.</p>
</div>
<div class="section" id="transport">
<h3>Transport<a class="headerlink" href="#transport" title="Permalink to this headline">¶</a></h3>
<p>The main role of a transport is to transfer packets between two sides.
You can select the transport implementation using the library configuration.</p>
<p>Currently the default transport is <a class="reference external" href="https://github.com/OpenAMP/open-amp/">OpenAMP</a> on <a class="reference external" href="https://www.zephyrproject.org">Zephyr</a>.</p>
<p>The template header describing the nRF RPC transport API is <code class="file docutils literal notranslate"><span class="pre">template/nrf_rpc_tr_tmpl.h</span></code>.
The header file <code class="file docutils literal notranslate"><span class="pre">include/rp_trans.h</span></code> is responsible for including the right transport header file based on the configuration.</p>
</div>
<div class="section" id="operating-system-abstraction">
<h3>Operating system abstraction<a class="headerlink" href="#operating-system-abstraction" title="Permalink to this headline">¶</a></h3>
<p>The operating system abstraction provides functionality for nRF RPC that depends on the operating system.
It manages the thread pool, thread synchronization, and communication.</p>
<p>The template header describing the OS abstraction is <code class="file docutils literal notranslate"><span class="pre">template/nrf_rpc_os_tmpl.h</span></code>.</p>
</div>
<div class="section" id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h3>
<p>nRF RPC logs some of its activities.
This allows for tracking, diagnosis, and debugging.
It provides four levels for logging: errors, warnings, information, and debug.</p>
<p>Error logs indicate serious errors, so they should be enabled if possible.
Debug logs should be enabled only to track specific problems.</p>
<p>The template header describing the logger is <code class="file docutils literal notranslate"><span class="pre">template/nrf_rpc_log_tmpl.h</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="usage.html" class="btn btn-neutral float-right" title="Implementing remote procedure calls" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../README.html" class="btn btn-neutral" title="Remote procedure call library (nRF RPC)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">

<table>
<tr>
<td>
    <p>
        &copy; Copyright 2019-2020, Nordic Semiconductor.
      Last updated on Sep 30, 2020.

    </p>
</td>
<td id="nordiclogo">
  <a href="https://www.nordicsemi.com/"><img src="../../_static/images/nordic.svg" border="0"/></a>
</td>
</tr>
</table>
  </div> 


</footer>
        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> nrfxlib</span>
       <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <div class="rst-other-version ncs">
        <a href="../../../nrf/index.html">nRF Connect SDK</a>
      </div>
      <div class="rst-other-version zephyr">
        <a href="../../../zephyr/index.html">Zephyr</a><br/>
      </div>
      <div class="rst-other-version mcuboot">
        <a href="../../../mcuboot/wrapper.html">MCUboot</a>
      </div>
      <div class="rst-other-version kconfig">
        <a href="../../../kconfig/index.html">Kconfig Reference</a>
      </div>
    </div>
  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>